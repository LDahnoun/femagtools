import femagtools.machine.im
import pathlib
import pytest
import numpy as np

from femagtools.machine.im import InductionMachine

@pytest.fixture
def im():
    impars = {
        "p": 2, "m": 3, "f1type": 50, "u1type": 230, "rotor_mass": 6, "kfric_b": 1,
        "r1": 0.2, "r2": 0.5389, "lsigma1": 2e-3,
        "lsigma2": 4.4e-3, "kh": 10, "zeta2": 1,
        "fec": 120, "fee": 0, "fexp": 7.0,
        "iml": 5.317456519935536, "ims": 3.425169199057511, "mexp": 8.75033417091787}
    return femagtools.machine.im.InductionMachine(impars)


def test_im(im):
    u1 = 230
    f1 = 50
    s = 0.01
    torque = im.torqueu(2*np.pi*f1, u1, 2*np.pi*(1-s)*f1/im.p)
    assert pytest.approx(torque, rel=0.01) == 17.77

def test_characteristics():
    m = {'r1': 0.675074272807, 'ls': 0.0, 'le': 0.0, 'wdgcon': 1.0, 'bar_temp': 80.0, 
         'im': [0.815370706376, 3.15956148721, 5.50375226804, 7.84794304887, 10.1921338297], 
         'psi': [0.110531890489, 0.42241005873, 0.64470403922, 0.742820604784, 0.791593101916],  
         'lsigma1': 0.00282975049013, 'lsigma2': 0.00170976658221, 'r2': 0.526553117684, 
         'u1ref': 230.940107676, 'f1ref': 49.9998282765, 'rotor_mass': 10.0742734696, 'kfric_b': 1.0,
         'zeta2': 0.983497740554, 'pl2v': 0.801009432234, 'psiref': 0.717940875943, 'wref': 314.158186388, 
         'fec': 61.5, 'fee': 0.0, 'fexp': 7.0,  'kth1': 0.0039, 'kth2': 0.0039, 'p': 4, 'm': 3, 'u_1': 165.0}
    
    op = {'n': [0.0, 16.0, 41.0], 
          'T': [50.0, 47.5, 42.5]}

    tmech = True
    im = InductionMachine(m)
    u1 = m['u_1']
    m.pop('u_1')

    r = im.characteristics(op['T'], op['n'], u1,with_tmech=tmech)

    expected = {'u1': [8.626730448164498, 55.20060596930911, 130.06064800168875], 
                'i1': [9.569545419830684, 9.39878941819307, 9.07326080573706], 
                'T': [50.0, 47.5, 42.5], 
                'cosphi': [0.9570216430842224, 0.6406348272451388, 0.5589956512165161], 
                'n': [0.0, 2.5464790894703255, 6.525352666767709], 
                's': [1.0, 0.056958184098880184, 0.02065759409989751], 
                'sk': [75.69370026548562, 0.7287338653296781, 0.5275557708539547], 
                'plfe1': [0.5999352966556608, 10.68156669453675, 28.955078902277293], 
                'plcu1': [185.4622133611452, 178.90378663977742, 166.731305339913], 
                'plcu2': [50.95542638810965, 45.99572494948215, 36.83832852439218], 
                'f1': [0.6475387455966559, 10.801129055076089, 26.651976377027527], 
                'plfw': [0.0, 1.5392356039165238, 3.944291235036092], 'pmech': [0.0, 760.0, 1742.5], 
                'losses': [237.01757504591052, 237.12031388771283, 236.46900400161857],
                  'eta': [0, 0.7621948820165996, 0.8805089905281684]}
    
    assert expected['losses'] == r['losses']
    assert expected['eta'] == r['eta']